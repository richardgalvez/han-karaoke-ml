<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HearAndNow Karaoke Song Recommendation</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
</head>
<body>
    <h1>HearAndNow Karaoke Song Recommendation System</h1>
    <a href="http://localhost:8888/notebooks/song-recommend-ml.ipynb" target="_blank">Check out the Jupyter Notebook for this project!</a>
    <h2>What would you like to sing?</h2>
    <form method="POST" action="/select_song" id="songForm">
        <table border="1">
            <tr>
                <th>Song Group</th>
                <th>HearAndNow Recommended Songs</th>
            </tr>
            {% for cluster in clusters['clusters'].unique() %}
                {% set random_song_data = clusters[clusters['clusters'] == cluster].sample(n=1)[['track_name', 'artist_name']].values[0] %}
                <tr class="song-row" data-song="{{ random_song_data[0] }}">
                    <td>{{ cluster }}</td>
                    <td>{{ random_song_data[0] }} by {{ random_song_data[1] }}</td>
                </tr>
            {% endfor %}
        </table>
        <input type="hidden" name="selected_song" id="selected_song_input" value="">
        <button type="button" class="submit-button" onclick="submitForm()">Submit</button>
        <button type="button" class="refreshButton" onclick="window.location.href='/refresh'">Re-Roll Songs</button>
    </form>

    <div id="selected-song">
        {% if selected_song %}
            <h3>Your Selected Song is:</h3>
            <h1>{{ selected_song }}</h1>
            <p>by:</p>
            <h2>{{ selected_song_artist }}</h2>
            <p>Search on <a href="https://www.youtube.com/results?search_query={{ selected_song }}+{{ selected_song_artist }}+karaoke" target="_blank">YouTube</a></p>
        {% endif %}
    </div>

    <div id="history-and-percentages">
        <div class="history-section">
            {% if user_selections %}
                <p>Previously Selected ({{ user_selections|length }}):</p>
                <div class="compact-list">
                    {% for song, count in user_selections.items() %}
                        {% set artist = clusters[clusters['track_name'] == song]['artist_name'].iloc[0] %}
                        <div>{{ song }} by {{ artist }}</div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No selections yet</p>
            {% endif %}
        </div>
    
        <div class="percentages-section">
            {% if cluster_percentages %}
                <p>Song Group Selection Rate (out of {{ user_selections|length }}):</p>
                <div class="compact-list">
                    {% for cluster, percentage in cluster_percentages.items() %}
                        {% set highlighted_class = 'highlighted-row' if loop.first %} {# Check if it's the first iteration (highest percentage) #}
                        <div class="{{ highlighted_class }}">Song Group {{ cluster }}: {{ "{:.2f}".format(percentage) }}%</div>
                    {% endfor %}
                </div>
            {% else %}
                <p>No selections yet</p>
            {% endif %}
        </div>
    </div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            var songRows = document.querySelectorAll('.song-row');

            songRows.forEach(function (row) {
                row.addEventListener('click', function () {
                    var selectedSongInput = document.getElementById('selected_song_input');
                    var submitButton = document.querySelector('.submit-button');
                    var selectedSong = this.dataset.song;

                    // Set the selected song in the hidden input.
                    selectedSongInput.value = selectedSong;

                    // Remove highlighting from all rows.
                    songRows.forEach(function (r) {
                        r.classList.remove('selected');
                    });

                    // Add highlighting to the selected row.
                    this.classList.add('selected');

                    // Enable the submit button.
                    submitButton.removeAttribute('disabled');
                });
            });
        });

        function submitForm() {
            document.getElementById('songForm').submit();
        }
    </script>
</body>
</html>
